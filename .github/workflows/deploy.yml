name: Deploy Services

# Only trigger, when the build workflow succeeded
on:
  workflow_run:
    workflows:
      [
        "Asset Manager - build",
        "Asset Server - build",
        "Prisma DB config - build",
      ]
    types:
      - completed

jobs:
  deploy:
    runs-on: srv
    steps:
      - uses: actions/checkout@v5

      - name: Create deploy folder
        run: |
          mkdir -p ~/deploy

      - name: Copy files
        run: |
          cp ./docker-compose.yml ~/deploy/docker-compose.yml
          cp -r ./tools/pgadmin_config ~/deploy/pgadmin_config

      - name: Update and run compose
        run: |
          docker compose pull && docker compose up -d

      - name: Prune docker
        run: |
          docker system prune -f
